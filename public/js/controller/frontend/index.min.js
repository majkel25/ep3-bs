(function ($) {

    $(function () {

        // ------------------------------------------------------------
        // Existing behaviour: hide submit button, show messages panel
        // ------------------------------------------------------------

        $("#calendar-toolbar-datepicker-submit").hide();

        var $messagesPanel = $(".messages-panel");
        var $calendar = $("#calendar");

        if ($messagesPanel.length && $calendar.length) {
            $messagesPanel
                .css({
                    position: "absolute",
                    "z-index": 2048,
                    "min-width": 384
                })
                .position({
                    my: "center top+24",
                    at: "center top",
                    of: $calendar
                })
                .delay(5000)
                .fadeOut(3000, function () {
                    $(this).remove();
                });

            $(document).trigger("updateLayout");
        }

        // ------------------------------------------------------------
        // NEW: "Notify me if a slot opens" date picker popup
        // ------------------------------------------------------------

        // Existing button from userpanel.online.phtml
        var $interestButton = $("#notify-day-btn");
        var $dialog = $("#interest-date-dialog");
        var $dateInput = $("#interest-date-input");

        if ($interestButton.length && $dialog.length && $dateInput.length) {

            // Prefer the specific date associated with the button, fall back to the global one
            var defaultDate = $interestButton.data("date") || window.currentBookingDate || null;

            // jQuery UI datepicker on the input
            $dateInput.datepicker({
                dateFormat: "yy-mm-dd",
                minDate: 0,
                defaultDate: defaultDate || 0,
                showButtonPanel: true
            });

            if (defaultDate) {
                $dateInput.datepicker("setDate", defaultDate);
            }

            // jQuery UI dialog
            $dialog.dialog({
                autoOpen: false,
                modal: true,
                resizable: false,
                width: 350,
                buttons: {
                    "OK": function () {
                        var dateStr = $.trim($dateInput.val());

                        if (!dateStr) {
                            alert("Please select a date first.");
                            return;
                        }

                        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                            alert("The selected date is not valid.");
                            return;
                        }

                        sendInterestRequest(dateStr);
                    },
                    "Cancel": function () {
                        $(this).dialog("close");
                    }
                },
                open: function () {
                    $dateInput.datepicker("refresh");
                }
            });

            // Open dialog on button click
            $interestButton.on("click", function (e) {
                e.preventDefault();
                $dialog.dialog("open");
            });
        }

        // ------------------------------------------------------------
        // AJAX call to /interest/register
        // ------------------------------------------------------------

        function sendInterestRequest(dateStr) {
            $.ajax({
                url: "/interest/register",
                method: "POST",
                dataType: "json",
                data: {
                    date: dateStr
                },
                success: function (resp) {
                    if (resp && resp.ok) {
                        $dialog.dialog("close");
                        alert(
                            "Your interest for " + dateStr + " has been registered.\n\n" +
                            "If a booking on this day is cancelled, you will receive a notification " +
                            "using your configured methods (email and/or WhatsApp, as set in My account)."
                        );
                    } else {
                        var err = (resp && resp.error) ? resp.error : "UNKNOWN_ERROR";
                        alert("Could not register your interest.\n\nError: " + err);
                    }
                },
                error: function (xhr) {
                    alert(
                        "Could not register your interest (server error).\n\n" +
                        "Status: " + xhr.status + " " + xhr.statusText
                    );
                }
            });
        }

    });

})(jQuery);
