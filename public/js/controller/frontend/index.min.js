(function ($) {

    $(function () {

        // ------------------------------------------------------------
        // Existing behaviour: hide submit button, show messages panel
        // ------------------------------------------------------------

        $("#calendar-toolbar-datepicker-submit").hide();

        var $messagesPanel = $(".messages-panel");
        var $calendar = $("#calendar");

        if ($messagesPanel.length && $calendar.length) {
            $messagesPanel
                .css({
                    position: "absolute",
                    "z-index": 2048,
                    "min-width": 384
                })
                .position({
                    my: "center top+24",
                    at: "center top",
                    of: $calendar
                })
                .delay(5000)
                .fadeOut(3000, function () {
                    $(this).remove();
                });

            $(document).trigger("updateLayout");
        }

        // ------------------------------------------------------------
        // NEW: "Notify me if a slot opens" popup WITHOUT jQuery UI dialog()
        // ------------------------------------------------------------

        var $interestButton = $("#notify-day-btn");          // from userpanel.online.phtml
        var $dialog = $("#interest-date-dialog");
        var $overlay = $("#interest-dialog-overlay");
        var $dateInput = $("#interest-date-input");
        var $btnOk = $("#interest-date-ok");
        var $btnCancel = $("#interest-date-cancel");

        if ($interestButton.length && $dialog.length && $overlay.length && $dateInput.length) {

            var defaultDate = $interestButton.data("date") || window.currentBookingDate || null;

            // Use jQuery UI datepicker if it exists (it should)
            if ($.fn.datepicker) {
                $dateInput.datepicker({
                    dateFormat: "yy-mm-dd",
                    minDate: 0,
                    defaultDate: defaultDate || 0,
                    showButtonPanel: true
                });

                if (defaultDate) {
                    $dateInput.datepicker("setDate", defaultDate);
                }
            } else {
                // Fallback: just pre-fill the input
                if (defaultDate) {
                    $dateInput.val(defaultDate);
                }
            }

            function openDialog() {
                if (defaultDate && $.fn.datepicker) {
                    $dateInput.datepicker("setDate", defaultDate);
                }
                $overlay.show();
                $dialog.show();
            }

            function closeDialog() {
                $dialog.hide();
                $overlay.hide();
            }

            $interestButton.on("click", function (e) {
                e.preventDefault();
                openDialog();
            });

            $btnCancel.on("click", function () {
                closeDialog();
            });

            $btnOk.on("click", function () {
                var dateStr = $.trim($dateInput.val());

                if (!dateStr) {
                    alert("Please select a date first.");
                    return;
                }

                if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    alert("The selected date is not valid.");
                    return;
                }

                sendInterestRequest(dateStr, closeDialog);
            });

            // Also close when clicking the dimmed overlay
            //$overlay.on("click", function () {
            //    closeDialog();
            //});
        }

        // ------------------------------------------------------------
        // AJAX call to /interest/register
        // ------------------------------------------------------------

        function sendInterestRequest(dateStr, onSuccessClose) {
            $.ajax({
                url: "/interest/register",
                method: "POST",
                dataType: "json",
                data: {
                    date: dateStr
                },
                success: function (resp) {
                    if (resp && resp.ok) {
                        if (typeof onSuccessClose === "function") {
                            onSuccessClose();
                        }
                        alert(
                            "Your interest for " + dateStr + " has been registered.\n\n" +
                            "If a booking on this day is cancelled, you will receive a notification " +
                            "using your configured methods (email and/or WhatsApp, as set in My account)."
                        );
                    } else {
                        var err = (resp && resp.error) ? resp.error : "UNKNOWN_ERROR";
                        alert("Could not register your interest.\n\nError: " + err);
                    }
                },
                error: function (xhr) {
                    alert(
                        "Could not register your interest (server error).\n\n" +
                        "Status: " + xhr.status + " " + xhr.statusText
                    );
                }
            });
        }

    });

})(jQuery);
